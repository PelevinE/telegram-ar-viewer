<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>3D/AR Viewer</title>
  <!-- Telegram WebApp JS -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- Three.js -->
  <script src="https://unpkg.com/three@0.152.2/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.152.2/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://unpkg.com/three@0.152.2/examples/js/controls/OrbitControls.js"></script>
  <style>
    body {
      margin: 0; font-family: system-ui, sans-serif;
      background: var(--tg-theme-bg-color, #202124);
      color: var(--tg-theme-text-color, #fff);
    }
    .header {
      padding: 1em; font-size: 1.3em; font-weight: bold;
      background: var(--tg-theme-header-bg-color, #19191a);
      text-align: center;
      border-bottom: 1px solid #444;
    }
    .container {
      max-width: 900px; margin: 0 auto; padding: 1em;
      display: flex; flex-direction: column; align-items: center;
    }
    .desc {
      background: var(--tg-theme-secondary-bg-color, #23232b);
      padding: 1em; border-radius: 10px; margin: 1em 0; width: 100%;
      max-width: 450px; font-size: 1.05em;
    }
    #viewerCanvas {
      background: #111; border-radius: 12px;
      width: 95vw; height: 60vw; max-width: 600px; max-height: 60vh;
      margin-bottom: 1em;
    }
    .btn {
      background: var(--tg-theme-button-color, #567ac6);
      color: var(--tg-theme-button-text-color, #fff);
      border: none; border-radius: 8px;
      padding: 0.7em 1.5em; font-size: 1em;
      cursor: pointer; margin-top: 1em;
      transition: background 0.2s;
    }
    .btn:active { background: #40518b; }
    .ar-hint { margin-top: 1em; color: #aaa; }
  </style>
</head>
<body>
  <div class="header" id="modelTitle">Загрузка...</div>
  <div class="container">
    <canvas id="viewerCanvas"></canvas>
    <button class="btn" id="arBtn">Открыть в AR</button>
    <div class="desc" id="modelDesc"></div>
    <div class="ar-hint" id="arHint"></div>
  </div>

  <script>
    // --- Получение параметров из URL ---
    function getQueryParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name) || '';
    }
    const modelUrl = getQueryParam('url');
    const modelTitle = decodeURIComponent(getQueryParam('title') || '');
    const modelDesc = decodeURIComponent(getQueryParam('desc') || '');

    document.getElementById('modelTitle').textContent = modelTitle || '3D/AR Viewer';
    document.getElementById('modelDesc').textContent = modelDesc || '';

    // --- Three.js Setup ---
    let scene, camera, renderer, controls, modelObj;
    const canvas = document.getElementById('viewerCanvas');
    initThree();

    function initThree() {
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(60, canvas.clientWidth/canvas.clientHeight, 0.01, 100);
      camera.position.set(0, 1, 3);

      renderer = new THREE.WebGLRenderer({canvas, alpha:true, antialias:true});
      renderer.setSize(canvas.clientWidth, canvas.clientHeight, false);

      scene.add(new THREE.AmbientLight(0xffffff, 1.2));
      controls = new THREE.OrbitControls(camera, renderer.domElement);

      // Load model
      if (!modelUrl) {
        alert("Не передан параметр url (3D модель).");
        return;
      }
      const loader = new THREE.GLTFLoader();
      loader.load(modelUrl, function(gltf){
        modelObj = gltf.scene;
        scene.add(modelObj);
        fitCameraToObject(camera, modelObj);
        animate();
      }, undefined, err=>{
        alert("Ошибка загрузки модели:\n" + err);
      });
    }

    function fitCameraToObject(camera, object) {
      const box = new THREE.Box3().setFromObject(object);
      const size = box.getSize(new THREE.Vector3());
      const center = box.getCenter(new THREE.Vector3());
      const maxDim = Math.max(size.x, size.y, size.z);
      camera.position.copy(center).add(new THREE.Vector3(0, maxDim*0.5, maxDim*2));
      camera.lookAt(center);
      controls.target.copy(center);
      controls.update();
    }

    function animate() {
      requestAnimationFrame(animate);
      renderer.render(scene, camera);
    }

    // --- AR Button ---
    const arBtn = document.getElementById('arBtn');
    const arHint = document.getElementById('arHint');

    let arSupported = false;
    // Проверка поддержки WebXR + AR
    if (navigator.xr && navigator.xr.isSessionSupported) {
      navigator.xr.isSessionSupported('immersive-ar').then(supported=>{
        arSupported = supported;
        if (!arSupported) {
          arBtn.style.display = 'none';
          arHint.textContent = "AR просмотр не поддерживается на этом устройстве.";
        }
      });
    } else {
      arBtn.style.display = 'none';
      arHint.textContent = "WebXR AR не поддерживается браузером.";
    }

    arBtn.onclick = () => {
      if (!arSupported) {
        alert("AR не поддерживается!");
        return;
      }
      startAR();
    };

    // --- AR Viewer (WebXR + Three.js) ---
    function startAR() {
      // Простейший AR viewer с WebXR
      let xrSession;
      renderer.xr.enabled = true;
      navigator.xr.requestSession('immersive-ar', {
        requiredFeatures: ['hit-test', 'local-floor']
      }).then(session => {
        xrSession = session;
        renderer.xr.setSession(session);

        // Хит-тест и простое размещение модели по тапу
        let refSpace, viewerSpace, hitTestSource = null;
        session.requestReferenceSpace('local-floor').then(rs=>{
          refSpace = rs;
          session.requestReferenceSpace('viewer').then(vs=>{
            viewerSpace = vs;
            session.requestHitTestSource({ space: viewerSpace }).then(hts=>{
              hitTestSource = hts;
            });
          });
        });

        const onSelect = (ev) => {
          // По тапу размещаем объект в точку
          if (!hitTestSource) return;
          session.requestAnimationFrame((time, frame) => {
            const hitTestResults = frame.getHitTestResults(hitTestSource);
            if (hitTestResults.length > 0) {
              const hit = hitTestResults[0];
              const pose = hit.getPose(refSpace);
              modelObj.position.copy(pose.transform.position);
            }
          });
        };
        session.addEventListener('select', onSelect);

        animate();
        session.addEventListener('end', ()=>{
          renderer.xr.enabled = false;
        });
      });
    }
  </script>
</body>
</html>